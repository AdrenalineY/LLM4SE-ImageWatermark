# Photo Watermark 2.0 开发需求规格说明文档

## 项目概述

基于现有的命令行图片水印工具，开发一个功能完整的桌面GUI应用程序，支持Windows和macOS平台。该应用将提供直观的用户界面，支持批量处理、实时预览、多种水印类型和灵活的配置管理。

## 技术架构建议

- **GUI框架**: tkinter (内置) 或 PyQt5/6 (功能更丰富)
- **图像处理**: PIL/Pillow (继承现有代码)
- **EXIF处理**: exifread (继承现有代码)
- **配置管理**: JSON文件存储
- **打包工具**: PyInstaller 或 cx_Freeze

## 第一阶段：基础需求实现

### 1. 文件处理模块

#### 1.1 导入图片功能
**需求描述**: 提供多种方式导入图片文件，支持单张和批量导入

**功能规格**:
- **单张导入**:
  - 支持拖拽单张图片到应用窗口
  - 提供"选择文件"按钮，打开文件对话框选择单张图片
  - 支持的拖拽区域应有明显的视觉提示

- **批量导入**:
  - 支持多选文件导入（Ctrl+点击或Shift+点击）
  - 提供"选择文件夹"按钮，导入整个文件夹中的所有支持格式图片
  - 支持拖拽整个文件夹到应用窗口
  - 递归扫描子文件夹（可选开关）

- **图片列表显示**:
  - 左侧面板显示已导入图片列表
  - 每个条目包含：64x64像素缩略图、文件名、文件大小
  - 支持列表项的删除操作
  - 支持清空所有列表项
  - 当前选中项高亮显示

**技术实现要点**:
```python
# 继承现有的图片格式支持
supported_formats = {'.jpg', '.jpeg', '.png', '.tiff', '.bmp'}

# 缩略图生成
def generate_thumbnail(image_path, size=(64, 64)):
    """生成缩略图，保持宽高比"""
    pass

# 拖拽支持
def setup_drag_drop():
    """设置拖拽事件处理"""
    pass
```

#### 1.2 格式支持
**需求描述**: 确保输入输出格式的完整支持

**输入格式支持**:
- **必须支持**: JPEG (.jpg, .jpeg), PNG (.png)
- **强烈建议**: BMP (.bmp), TIFF (.tiff, .tif)
- **PNG透明通道**: 完整保持PNG的Alpha通道透明度

**输出格式支持**:
- 用户可选择输出格式：JPEG 或 PNG
- 提供格式选择下拉菜单
- 根据选择的格式动态显示相关选项

**技术实现要点**:
```python
# 格式验证
def validate_image_format(file_path):
    """验证图片格式是否支持"""
    pass

# 透明度处理
def preserve_transparency(image):
    """保持PNG透明通道"""
    pass
```

#### 1.3 导出图片功能
**需求描述**: 提供灵活的导出选项和安全机制

**输出文件夹选择**:
- 提供"选择输出文件夹"按钮
- 默认禁止选择原图所在文件夹（防止覆盖）
- 显示当前选择的输出路径

**文件命名规则**:
- **保留原文件名**: 直接使用原始文件名
- **添加前缀**: 用户自定义前缀（默认: "wm_"）
- **添加后缀**: 用户自定义后缀（默认: "_watermarked"）
- 提供单选按钮组选择命名规则
- 实时预览文件名效果

**基础导出设置**:
- 输出格式选择（JPEG/PNG）
- 导出进度条显示
- 导出完成后的提示信息

**技术实现要点**:
```python
# 文件名生成
def generate_output_filename(original_path, naming_rule, prefix="", suffix=""):
    """根据命名规则生成输出文件名"""
    pass

# 安全检查
def check_output_safety(input_paths, output_dir):
    """检查输出目录是否安全（避免覆盖原文件）"""
    pass
```

### 2. 水印类型模块

#### 2.1 文本水印（基础版）
**需求描述**: 提供基本的文本水印功能

**文本内容**:
- 多行文本输入框，支持自定义任意文本
- 继承命令行版本的EXIF日期提取功能
- 提供"使用EXIF日期"快捷按钮

**基础样式设置**:
- **字体大小**: 滑块控制（范围: 12-200像素）
- **字体颜色**: 基础颜色选择器（预设8种常用颜色）
- **透明度**: 滑块控制（范围: 0-100%）

**技术实现要点**:
```python
# 继承现有文本水印功能
class TextWatermark:
    def __init__(self):
        # 继承现有的字体和颜色处理逻辑
        pass
    
    def apply_watermark(self, image, text, font_size, color, opacity, position):
        """应用文本水印"""
        pass
```

### 3. 水印布局与样式模块

#### 3.1 实时预览系统
**需求描述**: 提供所见即所得的预览体验

**预览窗口**:
- 主窗口中央显示当前选中图片的预览
- 预览图按比例缩放适应窗口大小
- 实时显示水印效果
- 预览图下方显示原始尺寸信息

**列表切换**:
- 点击左侧列表中的图片项切换预览
- 当前预览的图片在列表中高亮显示
- 支持键盘上下箭头键切换

**技术实现要点**:
```python
class PreviewWidget:
    def __init__(self):
        self.current_image = None
        self.preview_scale = 1.0
        
    def update_preview(self):
        """更新预览显示"""
        pass
        
    def calculate_preview_scale(self, image_size, widget_size):
        """计算预览缩放比例"""
        pass
```

#### 3.2 位置控制
**需求描述**: 提供直观的水印位置设置

**预设位置（九宫格）**:
- 九个预设位置按钮：左上、上中、右上、左中、居中、右中、左下、下中、右下
- 继承命令行版本的位置计算逻辑
- 点击按钮立即更新预览

**技术实现要点**:
```python
# 继承现有位置计算逻辑
position_presets = {
    'top-left': 'top_left',
    'top-center': 'top_center',
    'top-right': 'top_right',
    'center-left': 'center_left',
    'center': 'center',
    'center-right': 'center_right',
    'bottom-left': 'bottom_left',
    'bottom-center': 'bottom_center',
    'bottom-right': 'bottom_right'
}
```

### 4. 配置管理模块

#### 4.1 基础配置保存
**需求描述**: 保存和恢复用户设置

**自动保存**:
- 程序关闭时自动保存当前设置
- 程序启动时自动加载上次设置

**配置内容**:
- 水印文本内容
- 字体大小
- 颜色设置
- 透明度
- 位置选择
- 输出格式
- 文件命名规则

**技术实现要点**:
```python
import json
from pathlib import Path

class ConfigManager:
    def __init__(self):
        self.config_file = Path.home() / '.photo_watermark_config.json'
        
    def save_config(self, config_data):
        """保存配置到JSON文件"""
        pass
        
    def load_config(self):
        """从JSON文件加载配置"""
        pass
```

### 5. 用户界面设计

#### 5.1 主界面布局
```
┌─────────────────────────────────────────────────────────────┐
│ 菜单栏: 文件 | 编辑 | 视图 | 帮助                             │
├─────────────┬───────────────────────────┬───────────────────┤
│             │                           │                   │
│   图片列表   │        预览区域            │    设置面板        │
│             │                           │                   │
│ ┌─────────┐ │ ┌───────────────────────┐ │ ┌───────────────┐ │
│ │缩略图1  │ │ │                       │ │ │ 文本水印设置   │ │
│ │文件名   │ │ │     预览图片           │ │ │               │ │
│ └─────────┘ │ │                       │ │ │ 文本: _____   │ │
│ ┌─────────┐ │ │                       │ │ │ 大小: [===|  ]│ │
│ │缩略图2  │ │ │                       │ │ │ 颜色: [■]     │ │
│ │文件名   │ │ │                       │ │ │ 透明度:[====] │ │
│ └─────────┘ │ └───────────────────────┘ │ │               │ │
│     ...     │                           │ │ 位置设置       │ │
│             │                           │ │ [□][□][□]     │ │
│ [导入文件]   │                           │ │ [□][■][□]     │ │
│ [导入文件夹] │                           │ │ [□][□][□]     │ │
│ [清空列表]   │                           │ │               │ │
│             │                           │ │ 导出设置       │ │
│             │                           │ │ 格式:[JPEG▼]  │ │
│             │                           │ │ 命名:[原名▼]  │ │
│             │                           │ │               │ │
│             │                           │ │ [选择输出目录] │ │
│             │                           │ │ [开始导出]     │ │
│             │                           │ └───────────────┘ │
└─────────────┴───────────────────────────┴───────────────────┘
```

## 第二阶段：高级功能实现

### 1. 文件处理高级功能

#### 1.1 JPEG质量控制
**需求描述**: 为JPEG输出提供质量调节

**功能规格**:
- 质量滑块控制（范围: 0-100）
- 实时显示预估文件大小
- 质量预设按钮（低/中/高质量）

#### 1.2 图片尺寸调整
**需求描述**: 导出时调整图片尺寸

**功能规格**:
- 按宽度缩放
- 按高度缩放
- 按百分比缩放
- 保持宽高比选项
- 预览最终尺寸信息

### 2. 文本水印高级功能

#### 2.1 高级字体设置
**需求描述**: 提供完整的字体控制

**功能规格**:
- 系统字体列表下拉菜单
- 粗体/斜体复选框
- 字体预览功能

#### 2.2 高级颜色设置
**需求描述**: 提供专业的颜色选择

**功能规格**:
- 完整的调色板或颜色选择器
- RGB/HSV数值输入
- 最近使用颜色历史
- 颜色预设保存

#### 2.3 文字样式效果
**需求描述**: 增强文字在复杂背景下的可读性

**功能规格**:
- **阴影效果**:
  - 阴影偏移量控制（X/Y方向）
  - 阴影颜色选择
  - 阴影模糊程度
- **描边效果**:
  - 描边宽度控制
  - 描边颜色选择
  - 描边样式（实线/虚线）

### 3. 图片水印功能

#### 3.1 图片水印基础
**需求描述**: 支持使用图片作为水印

**功能规格**:
- 支持PNG、JPEG格式的水印图片
- 完整支持PNG透明通道
- 水印图片预览

#### 3.2 图片水印调整
**需求描述**: 提供图片水印的调整选项

**功能规格**:
- **缩放控制**:
  - 比例缩放滑块（10% - 200%）
  - 按像素大小调整
  - 保持宽高比选项
- **透明度控制**:
  - 整体透明度滑块（0-100%）
  - 预览透明效果

### 4. 高级布局功能

#### 4.1 手动拖拽定位
**需求描述**: 提供精确的位置控制

**功能规格**:
- 在预览图上直接拖拽水印
- 鼠标悬停时显示拖拽光标
- 拖拽过程中实时更新位置
- 边界检测（防止拖拽到图片外）

#### 4.2 旋转功能
**需求描述**: 支持水印任意角度旋转

**功能规格**:
- 旋转角度滑块（-180° 到 +180°）
- 角度数值输入框
- 预览旋转效果
- 重置到0度按钮

### 5. 高级配置管理

#### 5.1 水印模板系统
**需求描述**: 提供完整的模板管理功能

**功能规格**:
- **模板保存**:
  - 模板命名对话框
  - 保存所有当前设置参数
  - 模板预览缩略图生成

- **模板管理**:
  - 模板列表显示
  - 模板预览功能
  - 模板重命名
  - 模板删除（确认对话框）
  - 模板导入/导出功能

- **模板应用**:
  - 一键应用模板设置
  - 应用时的确认提示
  - 部分参数应用选项

## 技术实现架构

### 核心类设计

```python
class PhotoWatermarkApp:
    """主应用程序类"""
    def __init__(self):
        self.image_manager = ImageManager()
        self.watermark_engine = WatermarkEngine()
        self.config_manager = ConfigManager()
        self.ui_manager = UIManager()

class ImageManager:
    """图片管理类"""
    def __init__(self):
        self.image_list = []
        self.current_image = None
        self.supported_formats = {'.jpg', '.jpeg', '.png', '.tiff', '.bmp'}

class WatermarkEngine:
    """水印处理引擎，继承命令行版本的核心逻辑"""
    def __init__(self):
        # 继承现有的ImageWatermarker类功能
        pass

class ConfigManager:
    """配置管理类"""
    def __init__(self):
        self.templates = {}
        self.current_config = {}

class UIManager:
    """界面管理类"""
    def __init__(self):
        self.main_window = None
        self.preview_widget = None
        self.settings_panel = None
```

### 文件结构规划

```
photo_watermark_gui/
├── main.py                 # 程序入口
├── core/
│   ├── __init__.py
│   ├── image_manager.py    # 图片管理
│   ├── watermark_engine.py # 水印引擎（继承命令行版本）
│   └── config_manager.py   # 配置管理
├── ui/
│   ├── __init__.py
│   ├── main_window.py      # 主窗口
│   ├── preview_widget.py   # 预览组件
│   ├── settings_panel.py   # 设置面板
│   └── dialogs.py          # 对话框
├── utils/
│   ├── __init__.py
│   ├── file_utils.py       # 文件操作工具
│   └── image_utils.py      # 图片处理工具
├── resources/
│   ├── icons/              # 图标资源
│   └── fonts/              # 字体资源
├── config/
│   └── default_config.json # 默认配置
├── requirements.txt        # 依赖列表
└── build_scripts/
    ├── build_windows.py    # Windows打包脚本
    └── build_macos.py      # macOS打包脚本
```

## 开发里程碑

### Phase 1: 基础功能（第一阶段）
- [ ] 项目架构搭建
- [ ] 基础UI界面实现
- [ ] 图片导入和列表显示
- [ ] 基础文本水印功能
- [ ] 预设位置控制
- [ ] 实时预览系统
- [ ] 基础导出功能
- [ ] 配置保存/加载

### Phase 2: 高级功能（第二阶段）
- [ ] 高级文本样式（字体、颜色、效果）
- [ ] 图片水印功能
- [ ] 手动拖拽定位
- [ ] 旋转功能
- [ ] JPEG质量控制
- [ ] 图片尺寸调整
- [ ] 水印模板系统

### Phase 3: 打包发布
- [ ] Windows可执行文件生成
- [ ] macOS应用程序包生成
- [ ] 用户手册编写
- [ ] GitHub Release发布

## 质量要求

### 性能要求
- 预览更新响应时间 < 200ms
- 支持同时处理100张以内的图片
- 内存使用优化，避免同时加载所有原图

### 用户体验要求
- 界面响应流畅，无卡顿现象
- 操作逻辑清晰，易于理解
- 错误提示友好，提供解决建议
- 支持撤销/重做操作

### 兼容性要求
- Windows 10/11 64位
- macOS 10.14+
- 支持高DPI显示器
- 支持中英文界面（可选）

这份需求规格说明文档提供了详细的功能规格和技术实现指导，便于后续的开发工作。每个功能模块都包含了具体的实现要点和代码结构建议，确保开发过程的顺利进行。